name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Fast lint - runs on all pushes and PRs
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.63.4
      - name: golangci-lint
        run: golangci-lint run --timeout=5m

  # Full test suite - only on Release PRs and other PRs
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Check go.mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Test with coverage
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          fail_ci_if_error: false

  # Thorough checks - only on Release PRs
  release-checks:
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'release-please--')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.63.4
      - name: Full lint
        run: golangci-lint run --timeout=5m

      - name: Build all targets
        run: |
          GOOS=linux GOARCH=amd64 go build -o /dev/null ./cmd/drime
          GOOS=linux GOARCH=arm64 go build -o /dev/null ./cmd/drime
          GOOS=darwin GOARCH=amd64 go build -o /dev/null ./cmd/drime
          GOOS=darwin GOARCH=arm64 go build -o /dev/null ./cmd/drime
          GOOS=windows GOARCH=amd64 go build -o /dev/null ./cmd/drime

      - name: Test with race detector
        run: go test -race -count=1 ./...
